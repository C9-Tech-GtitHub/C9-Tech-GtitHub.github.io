<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Suggestion Reviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(to right, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #6b7280;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(to right, #1d4ed8, #1e40af);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-approve {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #bbf7d0;
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-approve:hover {
            background: #bbf7d0;
            border-color: #86efac;
        }

        .btn-approve.active {
            background: linear-gradient(to right, #22c55e, #16a34a);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .btn-deny {
            background: #fef2f2;
            color: #991b1b;
            border: 2px solid #fecaca;
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-deny:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        .btn-deny.active {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .btn-flag {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fde68a;
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-flag:hover {
            background: #fde68a;
            border-color: #fcd34d;
        }

        .btn-flag.active {
            background: linear-gradient(to right, #f59e0b, #d97706);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .btn-metafield {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-metafield:hover {
            background: #e0f2fe;
            border-color: #7dd3fc;
        }

        .upload-area {
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
        }

        .upload-icon {
            width: 3rem;
            height: 3rem;
            color: #9ca3af;
            margin: 0 auto 1rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .card.approved {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .card.denied {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .card.flagged {
            background: #fffbeb;
            border-color: #fde68a;
        }

        .card.modified {
            background: #f0f9ff;
            border-color: #bae6fd;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .image-container {
            aspect-ratio: 1;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            transition: opacity 0.3s ease;
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 0.75rem;
        }

        .image-icon {
            width: 4rem;
            height: 4rem;
            background: #dbeafe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }

        .image-error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .image-controls {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .image-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .image-controls button:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .product-details h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #111827;
        }

        .product-details p {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .product-meta {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .product-meta div {
            display: flex;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .product-meta div:last-child {
            margin-bottom: 0;
        }

        .product-meta span:first-child {
            font-weight: 500;
            color: #4b5563;
            margin-right: 0.5rem;
            min-width: 70px;
        }

        .product-meta a {
            color: #2563eb;
            text-decoration: none;
            word-break: break-all;
        }

        .product-meta a:hover {
            text-decoration: underline;
        }

        .category-toggle {
            cursor: pointer;
            color: #2563eb;
            transition: color 0.2s;
            flex: 1;
        }

        .category-toggle:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }

        .category-flag-btn {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }

        .category-flag-btn:hover {
            background: #fecaca;
        }

        .category-flag-btn.active {
            background: #dc2626;
            color: white;
        }

        .attributes-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #111827;
            display: flex;
            align-items: center;
        }

        .edit-mode-toggle {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-left: auto;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .edit-mode-toggle:hover {
            background: #e5e7eb;
        }

        .edit-mode-toggle.active {
            background: #2563eb;
            color: white;
        }

        .attributes-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .attributes-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .attributes-table th {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }

        .attributes-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        .attributes-table tr:hover {
            background: #f9fafb;
        }

        .detail-row-container:hover {
            background: transparent !important;
        }

        .detail-row-container td {
            border-bottom: none !important;
        }

        .attribute-name {
            font-weight: 500;
            color: #111827;
            position: relative;
            cursor: help;
        }

        .attribute-name:hover {
            color: #2563eb;
        }

        .attribute-value {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .attribute-value.selected {
            background: #fef3c7;
            color: #92400e;
        }

        .attribute-value.na {
            background: #fed7aa;
            color: #c2410c;
        }

        .attribute-value.modified {
            background: #dbeafe;
            color: #1d4ed8;
            border: 2px solid #3b82f6;
        }

        .attribute-value.custom-metafield {
            background: #f0f9ff;
            color: #0369a1;
            border: 2px solid #0ea5e9;
        }

        .custom-prefix {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .attribute-values-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .edit-mode-selector {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }

        .edit-mode-content {
            margin-bottom: 1rem;
        }

        .possible-values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .value-button {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
            min-height: 48px;
        }

        .value-button:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .value-button.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .value-button input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 16px;
            height: 16px;
        }

        .value-button span {
            flex: 1;
            text-align: center;
        }

        .value-dropdown {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .value-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-value-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .custom-value-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .custom-value-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
        }

        .remove-attribute-btn, .restore-attribute-btn {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            margin-left: 0.75rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .remove-attribute-btn:hover, .restore-attribute-btn:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        .restore-attribute-btn {
            background: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }

        .restore-attribute-btn:hover {
            background: #bbf7d0;
            border-color: #86efac;
        }

        .view-options {
            color: #4b5563;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }

        .view-options:hover {
            color: #111827;
        }

        .attribute-details {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .attribute-details.hidden {
            display: none;
        }

        .detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 500;
            color: #4b5563;
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #111827;
        }

        .possible-values {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .possible-value {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }

        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            max-width: 250px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-counter {
            text-align: center;
        }

        .nav-counter .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }

        .nav-counter .total {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .decisions-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .progress-bar {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }

        .progress-count {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }

        .progress-track {
            width: 100%;
            background: #e5e7eb;
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #3b82f6, #7c3aed);
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }

        .progress-percent {
            text-align: right;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .summary {
            background: linear-gradient(to right, #f9fafb, #f3f4f6);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .summary h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .summary-item {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .summary-number.approved { color: #16a34a; }
        .summary-number.denied { color: #dc2626; }
        .summary-number.flagged { color: #f59e0b; }
        .summary-number.pending { color: #4b5563; }

        .summary-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
        }

        .summary-bar {
            width: 2rem;
            height: 0.25rem;
            border-radius: 9999px;
            margin: 0.5rem auto 0;
        }

        .summary-bar.approved { background: #16a34a; }
        .summary-bar.denied { background: #dc2626; }
        .summary-bar.flagged { background: #f59e0b; }
        .summary-bar.pending { background: #9ca3af; }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .icon-small {
            width: 1rem;
            height: 1rem;
            margin-right: 0.25rem;
        }

        /* Metafield Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .modal-content {
            padding: 1.5rem;
        }

        .metafield-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .metafield-values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .metafield-value-input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .metafield-value-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        @media (max-width: 1024px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .decisions-section {
                flex-direction: column;
                gap: 0.75rem;
            }

            .metafield-values-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Tooltip for attribute descriptions -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Metafield Modal -->
    <div id="metafield-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Metafield</h3>
                <button class="modal-close" onclick="closeMetafieldModal()">&times;</button>
            </div>
            <div class="modal-content">
                <form class="metafield-form" onsubmit="addCustomMetafield(event)">
                    <div class="form-group">
                        <label class="form-label">Select Metafield Type</label>
                        <select id="metafield-type" class="form-select" onchange="handleMetafieldTypeChange()" required>
                            <option value="">Choose a metafield type...</option>
                            <option value="Volume">Volume</option>
                            <option value="Weight">Weight</option>
                            <option value="Occasion">Occasion</option>
                            <option value="Contents">Contents</option>
                            <option value="Receiver Features">Receiver Features</option>
                            <option value="Seasonal">Seasonal</option>
                            <option value="Gender Department">Gender Department</option>
                            <option value="Quality Tier">Quality Tier</option>
                            <option value="Plant Format">Plant Format</option>
                            <option value="Custom">Custom (Full Custom)</option>
                        </select>
                    </div>
                    
                    <!-- Custom fields shown only for "Custom" option -->
                    <div id="custom-fields" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Metafield Name</label>
                            <input type="text" id="metafield-name" class="form-input" placeholder="Enter custom metafield name...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description (Optional)</label>
                            <input type="text" id="metafield-description" class="form-input" placeholder="Describe this metafield...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Possible Values</label>
                            <div id="metafield-values-container">
                                <input type="text" class="metafield-value-input" placeholder="Enter possible value...">
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addValueInput()" style="margin-top: 0.5rem;">
                                <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Value
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Initial Selected Value (Optional)</label>
                        <input type="text" id="metafield-initial-value" class="form-input" placeholder="Set initial value...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMetafieldModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCustomMetafield()">
                    <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Metafield
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1 class="title">Enhanced AI Suggestion Reviewer</h1>
                <p class="subtitle" id="product-counter"></p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="https://c9-tech-gtithub.github.io/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    Toolbox
                </a>
                <button id="export-btn" class="btn btn-primary hidden">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export (<span id="export-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- File Upload -->
        <div id="upload-section" class="upload-area">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h3 style="font-size: 1.125rem; font-weight: 500; color: #111827; margin-bottom: 0.5rem;">Upload CSV File</h3>
            <p style="color: #6b7280; margin-bottom: 1rem;">Select your AI suggestions CSV file to begin reviewing</p>
            <input type="file" accept=".csv" id="csv-upload" style="display: none;">
            <label for="csv-upload" class="btn btn-primary" style="cursor: pointer;">Choose File</label>
        </div>

        <!-- Loading -->
        <div id="loading-section" class="loading hidden">
            <div class="spinner"></div>
            <p style="color: #4b5563;">Processing CSV...</p>
        </div>

        <!-- Product Review -->
        <div id="review-section" class="hidden">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-header">
                    <span class="progress-title">Review Progress</span>
                    <span class="progress-count" id="progress-count">0 of 0 reviewed</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-percent" id="progress-percent">0% complete</div>
            </div>

            <!-- Decision Buttons -->
            <div class="decisions-section">
                <button id="approve-btn" class="btn-approve">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span id="approve-text">Approve Suggestions</span>
                </button>
                <button id="deny-btn" class="btn-deny">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Deny Suggestions
                </button>
                <button id="flag-btn" class="btn-flag">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 2h7a2 2 0 012 2v7a2 2 0 01-2 2h-7.5l-1-2H5a2 2 0 00-2 2zm9-13.5V9"></path>
                    </svg>
                    Flag for Manual Enhancement
                </button>
            </div>

            <!-- Product Card -->
            <div id="product-card" class="card">
                <div class="product-grid">
                    <!-- Product Image -->
                    <div>
                        <div class="image-container">
                            <img id="product-image" class="product-image hidden" alt="Product Image">
                            <div id="image-placeholder" class="image-placeholder">
                                <div class="image-icon">
                                    <svg style="width: 2rem; height: 2rem; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <h3 id="image-status" style="font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Loading Image...</h3>
                                <p id="image-description" style="font-size: 0.875rem; color: #4b5563; margin-bottom: 1rem;">Please wait while we load the product image</p>
                                <div id="image-error" class="image-error hidden"></div>
                            </div>
                            <div class="image-loading" id="image-loading">
                                <div class="spinner" style="width: 1.5rem; height: 1.5rem; margin: 0;"></div>
                            </div>
                            <div class="image-controls">
                                <button id="retry-image-btn" class="hidden">Retry</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="product-details">
                        <h1 id="product-title">Product Title</h1>
                        <p id="product-description">Product description...</p>
                        
                        <div class="product-meta" id="product-meta">
                            <div>
                                <span>URL:</span>
                                <a id="product-url" href="#" target="_blank" rel="noopener noreferrer">Product URL</a>
                            </div>
                            <div>
                                <span>Category:</span>
                                <span id="product-category" class="category-toggle">Category</span>
                                <button id="category-flag-btn" class="category-flag-btn">
                                    <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 2h7a2 2 0 012 2v7a2 2 0 01-2 2h-7.5l-1-2H5a2 2 0 00-2 2zm9-13.5V9"></path>
                                    </svg>
                                    Wrong Category
                                </button>
                            </div>
                        </div>

                        <!-- Attributes -->
                        <div class="attributes-section">
                            <h3>
                                AI Suggested Attributes
                                <div style="margin-left: auto; display: flex; align-items: center;">
                                    <button id="add-metafield-btn" class="btn-metafield" onclick="openMetafieldModal()">
                                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add Metafield
                                    </button>
                                    <button id="edit-mode-toggle" class="edit-mode-toggle">
                                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Edit Mode
                                    </button>
                                </div>
                            </h3>
                            <div class="attributes-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Attribute</th>
                                            <th>Selected Values</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attributes-body">
                                        <!-- Attributes will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div id="summary-section" class="summary hidden">
                <h3>Review Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-number approved" id="approved-count">0</div>
                        <div class="summary-label">Approved</div>
                        <div class="summary-bar approved"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number denied" id="denied-count">0</div>
                        <div class="summary-label">Denied</div>
                        <div class="summary-bar denied"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number flagged" id="flagged-count">0</div>
                        <div class="summary-label">Flagged</div>
                        <div class="summary-bar flagged"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number pending" id="pending-count">0</div>
                        <div class="summary-label">Pending</div>
                        <div class="summary-bar pending"></div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button id="prev-btn" class="btn btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="nav-counter">
                    <div class="number" id="current-index">1</div>
                    <div class="total" id="total-count">of 0</div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button id="skip-btn" class="btn btn-secondary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3-3 3m-4-6l3 3-3 3"></path>
                        </svg>
                        Skip
                    </button>
                    <button id="next-btn" class="btn btn-secondary">
                        Next
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let csvData = null;
        let groupedProducts = [];
        let currentProductIndex = 0;
        let productImages = {};
        let decisions = {};
        let productChanges = {}; // Track changes per product
        let categoryFlags = {}; // Track category flags
        let categoryNotes = {}; // Track category flag notes
        let enhancementNotes = {}; // Track enhancement flag notes
        let removedAttributes = {}; // Track removed/N/A attributes per product
        let imagePreloadCache = {};
        let categoryExpanded = false;
        let editMode = false;
        let customMetafields = {}; // Track custom metafields per product

        // Predefined metafield types and their possible values
        const metafieldTypes = {
            'Volume': ['Small (0-50ml)', 'Medium (50-200ml)', 'Large (200-500ml)', 'Extra Large (500ml+)', 'Mini (Under 30ml)', 'Travel Size (30-100ml)'],
            'Weight': ['Light (Under 100g)', 'Medium (100-500g)', 'Heavy (500g-1kg)', 'Extra Heavy (1kg+)', 'Featherweight (Under 50g)'],
            'Occasion': ['Birthday', 'Anniversary', 'Wedding', 'Christmas', 'Valentine\'s Day', 'Mother\'s Day', 'Father\'s Day', 'Graduation', 'Thank You', 'Sympathy', 'Housewarming', 'New Baby', 'Get Well Soon'],
            'Contents': ['Flowers Only', 'Flowers + Vase', 'Flowers + Chocolates', 'Flowers + Wine', 'Flowers + Card', 'Flowers + Balloon', 'Flowers + Teddy Bear', 'Mixed Bundle'],
            'Receiver Features': ['For Her', 'For Him', 'For Couple', 'For Family', 'For Pet Lover', 'For Gardener', 'For Elderly', 'For Teen', 'For Child', 'Unisex'],
            'Seasonal': ['Spring', 'Summer', 'Autumn', 'Winter', 'All Season', 'Holiday Specific', 'Seasonal Transition'],
            'Gender Department': ['Women', 'Men', 'Unisex', 'Children', 'Teen Girls', 'Teen Boys', 'Baby Girls', 'Baby Boys'],
            'Quality Tier': ['Premium', 'Standard', 'Budget', 'Luxury', 'Economy', 'Professional Grade', 'Commercial Grade'],
            'Plant Format': ['Fresh Cut Flowers', 'Potted Plants', 'Dried Flowers', 'Artificial', 'Seeds', 'Bulbs', 'Succulents', 'Herbs', 'Vegetables', 'Trees/Shrubs']
        };

        // DOM elements
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const reviewSection = document.getElementById('review-section');
        const csvUpload = document.getElementById('csv-upload');
        const exportBtn = document.getElementById('export-btn');
        const productCard = document.getElementById('product-card');
        const tooltip = document.getElementById('tooltip');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            csvUpload.addEventListener('change', handleFileUpload);
            exportBtn.addEventListener('click', exportDecisions);
            
            document.getElementById('prev-btn').addEventListener('click', prevProduct);
            document.getElementById('next-btn').addEventListener('click', nextProduct);
            document.getElementById('skip-btn').addEventListener('click', skipProduct);
            document.getElementById('approve-btn').addEventListener('click', () => handleDecision('approve'));
            document.getElementById('deny-btn').addEventListener('click', () => handleDecision('deny'));
            document.getElementById('flag-btn').addEventListener('click', () => handleDecision('flag'));
            document.getElementById('retry-image-btn').addEventListener('click', retryImage);
            document.getElementById('product-category').addEventListener('click', toggleCategory);
            document.getElementById('category-flag-btn').addEventListener('click', toggleCategoryFlag);
            document.getElementById('edit-mode-toggle').addEventListener('click', toggleEditMode);

            // Tooltip event listeners
            document.addEventListener('mouseover', handleTooltip);
            document.addEventListener('mouseout', hideTooltip);
        }

        // Metafield Modal Functions
        function openMetafieldModal() {
            const modal = document.getElementById('metafield-modal');
            modal.classList.add('visible');
            
            // Reset form
            document.getElementById('metafield-type').value = '';
            document.getElementById('metafield-name').value = '';
            document.getElementById('metafield-description').value = '';
            document.getElementById('metafield-initial-value').value = '';
            document.getElementById('metafield-values-container').innerHTML = '<input type="text" class="metafield-value-input" placeholder="Enter possible value...">';
            document.getElementById('custom-fields').classList.add('hidden');
        }

        function closeMetafieldModal() {
            const modal = document.getElementById('metafield-modal');
            modal.classList.remove('visible');
        }

        function handleMetafieldTypeChange() {
            const type = document.getElementById('metafield-type').value;
            const customFields = document.getElementById('custom-fields');
            
            if (type === 'Custom') {
                customFields.classList.remove('hidden');
                // Make name required for custom fields
                document.getElementById('metafield-name').setAttribute('required', 'required');
            } else {
                customFields.classList.add('hidden');
                // Remove required attribute for predefined types
                document.getElementById('metafield-name').removeAttribute('required');
            }
        }

        function addValueInput() {
            const container = document.getElementById('metafield-values-container');
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'metafield-value-input';
            newInput.placeholder = 'Enter possible value...';
            newInput.style.marginTop = '0.5rem';
            container.appendChild(newInput);
        }

        function addCustomMetafield() {
            const type = document.getElementById('metafield-type').value;
            const initialValue = document.getElementById('metafield-initial-value').value.trim();
            
            if (!type) {
                alert('Please select a metafield type.');
                return;
            }
            
            let name, description, possibleValues;
            
            if (type === 'Custom') {
                // Handle fully custom metafield
                name = document.getElementById('metafield-name').value.trim();
                description = document.getElementById('metafield-description').value.trim();
                
                if (!name) {
                    alert('Please enter a name for the custom metafield.');
                    return;
                }
                
                // Collect possible values
                const valueInputs = document.querySelectorAll('.metafield-value-input');
                possibleValues = Array.from(valueInputs)
                    .map(input => input.value.trim())
                    .filter(value => value.length > 0);
                
                if (possibleValues.length === 0) {
                    alert('Please add at least one possible value.');
                    return;
                }
            } else {
                // Handle predefined metafield type
                name = type;
                description = `Predefined ${type} metafield`;
                possibleValues = metafieldTypes[type] || [];
                
                if (possibleValues.length === 0) {
                    alert('No predefined values found for this metafield type.');
                    return;
                }
            }
            
            // Create new metafield attribute
            const currentProduct = groupedProducts[currentProductIndex];
            const newAttribute = {
                attribute_name: name,
                attribute_handle: name.toLowerCase().replace(/\s+/g, '_'),
                attribute_description: description,
                possible_values: possibleValues.join(', '),
                selected_value: initialValue,
                ai_provider: type === 'Custom' ? 'Custom Metafield' : 'Predefined Metafield',
                processing_date: new Date().toISOString().split('T')[0],
                original_selected_value: initialValue,
                current_selected_values: initialValue ? [initialValue] : [],
                is_custom_metafield: true
            };
            
            // Add to current product
            currentProduct.attributes.push(newAttribute);
            
            // Track as custom metafield
            if (!customMetafields[currentProduct.address]) {
                customMetafields[currentProduct.address] = [];
            }
            customMetafields[currentProduct.address].push(newAttribute);
            
            // Mark product as changed
            markProductAsChanged();
            
            // Update display
            updateAttributesTable(currentProduct.attributes);
            updateApproveButtonText();
            
            // Close modal
            closeMetafieldModal();
            
            // Show success message
            alert(`Metafield "${name}" added successfully!`);
        }

        function removeAttribute(attrIndex) {
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
            
            const attribute = currentProduct.attributes[attrIndex];
            const attrKey = attribute.attribute_handle || attribute.attribute_name;
            
            if (!removedAttributes[currentProduct.address]) {
                removedAttributes[currentProduct.address] = [];
            }
            
            if (!removedAttributes[currentProduct.address].includes(attrKey)) {
                removedAttributes[currentProduct.address].push(attrKey);
                markProductAsChanged();
                updateAttributesTable(currentProduct.attributes);
                updateApproveButtonText();
            }
        }

        function restoreAttribute(attrIndex) {
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
            
            const attribute = currentProduct.attributes[attrIndex];
            const attrKey = attribute.attribute_handle || attribute.attribute_name;
            
            if (removedAttributes[currentProduct.address]) {
                removedAttributes[currentProduct.address] = removedAttributes[currentProduct.address].filter(key => key !== attrKey);
                
                // If no more removed attributes for this product, clean up
                if (removedAttributes[currentProduct.address].length === 0) {
                    delete removedAttributes[currentProduct.address];
                }
                
                markProductAsChanged();
                updateAttributesTable(currentProduct.attributes);
                updateApproveButtonText();
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            
            try {
                const text = await file.text();
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim(),
                    transform: (value) => value.trim(),
                    complete: function(parsed) {
                        if (parsed.errors.length > 0) {
                            console.error('CSV parsing errors:', parsed.errors);
                        }
                        
                        processData(parsed.data);
                        hideLoading();
                        showReviewSection();
                    }
                });
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                alert('Error parsing CSV file. Please check the format.');
                hideLoading();
            }
        }

        function processData(data) {
            csvData = data;
            
            // Group by product address
            const grouped = {};
            const images = {};
            
            data.forEach((row, index) => {
                const address = row.address;
                if (!address) {
                    console.warn(`Row ${index} missing address:`, row);
                    return;
                }

                if (!grouped[address]) {
                    grouped[address] = {
                        title: row.title || '',
                        h1: row.title || '',
                        description: row.clean_description || '',
                        address: row.address || '',
                        handle: row.handle || '',
                        shopify_category: row.shopify_category || '',
                        google_category_ids: row.google_category_ids || '',
                        attributes: []
                    };
                    
                    // Store the image_url for this product
                    const imageUrl = row.image_url;
                    if (imageUrl && imageUrl.trim()) {
                        let cleanUrl = imageUrl.trim();
                        if (cleanUrl.startsWith('http://')) {
                            cleanUrl = cleanUrl.replace('http://', 'https://');
                        }
                        images[address] = cleanUrl;
                    } else {
                        images[address] = null;
                    }
                }
                
                grouped[address].attributes.push({
                    attribute_name: row.attribute_name || '',
                    attribute_handle: row.attribute_handle || '',
                    attribute_description: row.attribute_description || '',
                    possible_values: row.possible_values || '',
                    selected_value: row.selected_value || '',
                    ai_provider: row.ai_provider || '',
                    processing_date: row.processing_date || '',
                    original_selected_value: row.selected_value || '', // Keep original
                    current_selected_values: row.selected_value ? [row.selected_value] : [], // Support multiple
                    is_custom_metafield: false
                });
            });
            
            groupedProducts = Object.values(grouped);
            productImages = images;
            
            // Initialize tracking objects
            decisions = {};
            productChanges = {};
            categoryFlags = {};
            categoryNotes = {};
            enhancementNotes = {};
            customMetafields = {};
            removedAttributes = {};
            
            console.log('Loaded', groupedProducts.length, 'products with', Object.keys(images).length, 'images');
            
            currentProductIndex = 0;
            updateDisplay();
            preloadNextImages();
        }

        function showLoading() {
            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            reviewSection.classList.add('hidden');
        }

        function hideLoading() {
            loadingSection.classList.add('hidden');
        }

        function showReviewSection() {
            reviewSection.classList.remove('hidden');
        }

        function preloadNextImages() {
            for (let i = 1; i <= 3; i++) {
                const nextIndex = currentProductIndex + i;
                if (nextIndex < groupedProducts.length) {
                    const nextProduct = groupedProducts[nextIndex];
                    const imageUrl = productImages[nextProduct.address];
                    if (imageUrl && !imagePreloadCache[imageUrl]) {
                        const img = new Image();
                        img.onload = () => { imagePreloadCache[imageUrl] = true; };
                        img.src = imageUrl;
                    }
                }
            }
        }

        function loadProductImage(imageUrl, productAddress) {
            const imageElement = document.getElementById('product-image');
            const placeholderElement = document.getElementById('image-placeholder');
            const loadingElement = document.getElementById('image-loading');
            const statusElement = document.getElementById('image-status');
            const descriptionElement = document.getElementById('image-description');
            const errorElement = document.getElementById('image-error');
            const retryBtn = document.getElementById('retry-image-btn');

            imageElement.classList.add('hidden');
            placeholderElement.classList.remove('hidden');
            errorElement.classList.add('hidden');
            retryBtn.classList.add('hidden');

            if (!imageUrl) {
                statusElement.textContent = 'No Image Available';
                descriptionElement.textContent = 'This product does not have an associated image';
                return;
            }

            if (imagePreloadCache[imageUrl]) {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
                return;
            }

            statusElement.textContent = 'Loading Image...';
            descriptionElement.textContent = 'Please wait while we load the product image';
            loadingElement.style.display = 'block';

            const testImage = new Image();
            
            testImage.onload = function() {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
                loadingElement.style.display = 'none';
                imagePreloadCache[imageUrl] = true;
            };

            testImage.onerror = function() {
                loadingElement.style.display = 'none';
                statusElement.textContent = 'Image Load Failed';
                descriptionElement.textContent = 'Unable to load the product image';
                errorElement.textContent = `Failed to load: ${imageUrl}`;
                errorElement.classList.remove('hidden');
                retryBtn.classList.remove('hidden');
            };

            testImage.src = imageUrl;
        }

        function retryImage() {
            const currentProduct = groupedProducts[currentProductIndex];
            const imageUrl = productImages[currentProduct.address];
            if (imageUrl) {
                delete imagePreloadCache[imageUrl];
                loadProductImage(imageUrl, currentProduct.address);
            }
        }

        function toggleCategory() {
            const categoryElement = document.getElementById('product-category');
            const currentProduct = groupedProducts[currentProductIndex];
            
            categoryExpanded = !categoryExpanded;
            
            if (categoryExpanded) {
                categoryElement.textContent = currentProduct.shopify_category;
            } else {
                categoryElement.textContent = currentProduct.shopify_category.split(' > ').pop();
            }
        }

        function toggleCategoryFlag() {
            const currentProduct = groupedProducts[currentProductIndex];
            const flagBtn = document.getElementById('category-flag-btn');
            
            if (categoryFlags[currentProduct.address]) {
                // Remove flag and notes
                delete categoryFlags[currentProduct.address];
                delete categoryNotes[currentProduct.address];
                flagBtn.classList.remove('active');
            } else {
                // Prompt for notes about the correct category
                const notes = prompt('Why is this category wrong? What should it be?\n\nExample: "Should be Home & Garden > Plants instead of Gifts"');
                if (notes !== null) { // User didn't cancel
                    categoryFlags[currentProduct.address] = true;
                    categoryNotes[currentProduct.address] = notes.trim();
                    flagBtn.classList.add('active');
                }
            }
            
            updateCardStyling();
        }

        function toggleEditMode() {
            editMode = !editMode;
            const toggleBtn = document.getElementById('edit-mode-toggle');
            
            if (!toggleBtn) {
                console.error('Edit mode toggle button not found');
                return;
            }
            
            try {
                if (editMode) {
                    toggleBtn.classList.add('active');
                    toggleBtn.innerHTML = `
                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Exit Edit Mode
                    `;
                } else {
                    toggleBtn.classList.remove('active');
                    toggleBtn.innerHTML = `
                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Edit Mode
                    `;
                }
                
                // Safely update attributes table
                if (groupedProducts.length > 0 && currentProductIndex < groupedProducts.length) {
                    const currentProduct = groupedProducts[currentProductIndex];
                    if (currentProduct && currentProduct.attributes) {
                        updateAttributesTable(currentProduct.attributes);
                    }
                }
            } catch (error) {
                console.error('Error in toggleEditMode:', error);
                editMode = !editMode; // Revert the change
            }
        }

        function handleTooltip(event) {
            if (event.target.classList.contains('attribute-name')) {
                const attrIndex = parseInt(event.target.getAttribute('data-attr-index'));
                const currentProduct = groupedProducts[currentProductIndex];
                const attribute = currentProduct.attributes[attrIndex];
                
                if (attribute && attribute.attribute_description) {
                    showTooltip(event.target, attribute.attribute_description);
                }
            }
        }

        function showTooltip(element, text) {
            tooltip.textContent = text;
            tooltip.classList.add('visible');
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
        }

        function updateDisplay() {
            if (groupedProducts.length === 0) return;
            
            const currentProduct = groupedProducts[currentProductIndex];
            
            categoryExpanded = false;
            
            document.getElementById('product-counter').textContent = 
                `Product ${currentProductIndex + 1} of ${groupedProducts.length}`;
            
            document.getElementById('current-index').textContent = currentProductIndex + 1;
            document.getElementById('total-count').textContent = `of ${groupedProducts.length}`;
            
            document.getElementById('prev-btn').disabled = currentProductIndex === 0;
            document.getElementById('next-btn').disabled = currentProductIndex === groupedProducts.length - 1;
            document.getElementById('skip-btn').disabled = currentProductIndex === groupedProducts.length - 1;
            
            document.getElementById('product-title').textContent = currentProduct.h1;
            document.getElementById('product-description').textContent = currentProduct.description;
            
            const productUrl = document.getElementById('product-url');
            
            // Handle URL display - use wildpoppies base if needed
            let displayUrl = currentProduct.address;
            if (!displayUrl.startsWith('http')) {
                displayUrl = `https://www.wildpoppies.co.nz/products/${displayUrl}`;
            }
            
            productUrl.href = displayUrl;
            productUrl.textContent = displayUrl.replace('https://www.wildpoppies.co.nz/products/', '');
            
            document.getElementById('product-category').textContent = 
                currentProduct.shopify_category.split(' > ').pop();
            
            // Update category flag button
            const categoryFlagBtn = document.getElementById('category-flag-btn');
            categoryFlagBtn.classList.toggle('active', !!categoryFlags[currentProduct.address]);
            
            const currentImageUrl = productImages[currentProduct.address];
            loadProductImage(currentImageUrl, currentProduct.address);
            
            updateAttributesTable(currentProduct.attributes);
            updateDecisionButtons();
            updateProgress();
            updateCardStyling();
            updateApproveButtonText();
            
            preloadNextImages();
        }

        function updateAttributesTable(attributes) {
            const tbody = document.getElementById('attributes-body');
            tbody.innerHTML = '';
            
            attributes.forEach((attr, index) => {
                const row = document.createElement('tr');
                const hasChanges = hasAttributeChanges(attr);
                const currentProduct = groupedProducts[currentProductIndex];
                const isRemoved = removedAttributes[currentProduct.address] && 
                                removedAttributes[currentProduct.address].includes(attr.attribute_handle || attr.attribute_name);
                
                // Check if this is a CUSTOM_ prefixed attribute (in handle or name)
                const isCustomPrefixed = (attr.attribute_handle && attr.attribute_handle.startsWith('CUSTOM_')) || 
                                        (attr.attribute_name && attr.attribute_name.startsWith('CUSTOM_'));
                
                let displayName;
                if (attr.attribute_handle && attr.attribute_handle.startsWith('CUSTOM_')) {
                    displayName = attr.attribute_handle.replace('CUSTOM_', '');
                } else if (attr.attribute_name && attr.attribute_name.startsWith('CUSTOM_')) {
                    displayName = attr.attribute_name.replace('CUSTOM_', '');
                } else {
                    displayName = attr.attribute_name;
                }

                // Hide removed attributes completely
                if (isRemoved) {
                    row.style.display = 'none';
                }
                row.classList.add('attribute-row');
                
                row.innerHTML = `
                    <td>
                        <span class="attribute-name" data-attr-index="${index}">
                            ${isCustomPrefixed ? '<span class="custom-prefix">CUSTOM</span>' : ''}${displayName}
                            ${attr.is_custom_metafield ? '<span class="attribute-value custom-metafield" style="margin-left: 0.5rem; font-size: 0.7rem;">CUSTOM</span>' : ''}
                            ${editMode ? (isRemoved ? 
                                `<button class="restore-attribute-btn" onclick="restoreAttribute(${index})">
                                    <svg style="width: 0.75rem; height: 0.75rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Restore
                                </button>` :
                                `<button class="remove-attribute-btn" onclick="removeAttribute(${index})">
                                    <svg style="width: 0.75rem; height: 0.75rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Mark N/A
                                </button>`
                            ) : ''}
                        </span>
                    </td>
                    <td>
                        <div class="attribute-values-container" id="values-container-${index}">
                            ${renderAttributeValues(attr, index, hasChanges)}
                        </div>
                    </td>
                    <td>
                        <span class="view-options" data-index="${index}">View Details </span>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Add detail row
                const detailRow = document.createElement('tr');
                detailRow.className = 'detail-row-container';
                
                // Hide detail row if attribute is removed
                if (isRemoved) {
                    detailRow.style.display = 'none';
                }
                
                // In edit mode, show first non-removed attribute details by default, hide others
                const shouldShowDetails = editMode ? (index === 0 && !isRemoved) : false;
                
                detailRow.innerHTML = `
                    <td colspan="3" style="padding: 0; border: none;">
                        <div class="attribute-details ${shouldShowDetails ? '' : 'hidden'}" id="details-${index}">
                            <div class="detail-row">
                                <span class="detail-label">Description:</span>
                                <span class="detail-value">${attr.attribute_description || 'No description available'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Source:</span>
                                <span class="detail-value">${attr.is_custom_metafield ? 'Custom Metafield' : (attr.ai_provider || 'AI Generated')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Possible Values:</span>
                                <div class="detail-value">
                                    <div class="possible-values">
                                        ${attr.possible_values ? 
                                            (attr.possible_values.includes(';') ? 
                                                attr.possible_values.split(';') : 
                                                attr.possible_values.split(',')
                                            ).map(val => 
                                                `<span class="possible-value">${val.trim()}</span>`
                                            ).join('') : 
                                            '<span style="color: #6b7280;">No values specified</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                            ${editMode && !isRemoved ? `
                                <div class="edit-container" id="edit-container-${index}">
                                    ${renderEditContainer(attr, index)}
                                </div>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(detailRow);
                
                // Add click handler for view options
                row.querySelector('.view-options').addEventListener('click', function() {
                    const detailsDiv = document.getElementById(`details-${index}`);
                    const isHidden = detailsDiv.classList.contains('hidden');
                    
                    if (isHidden) {
                        detailsDiv.classList.remove('hidden');
                        this.textContent = 'Hide Details ';
                    } else {
                        detailsDiv.classList.add('hidden');
                        this.textContent = 'View Details ';
                    }
                });

                // Set initial view options text based on whether details are shown
                const viewOptionsSpan = row.querySelector('.view-options');
                if (shouldShowDetails) {
                    viewOptionsSpan.textContent = 'Hide Details ';
                } else {
                    viewOptionsSpan.textContent = 'View Details ';
                }

                // Setup edit mode listeners if in edit mode
                if (editMode) {
                    setupEditListeners(attr, index);
                }
            });
        }

        function renderAttributeValues(attr, index, hasChanges) {
            const values = attr.current_selected_values || [];
            
            if (values.length === 0) {
                return `<span class="attribute-value na">N/A</span>`;
            }
            
            const baseClass = attr.is_custom_metafield ? 'custom-metafield' : (hasChanges ? 'modified' : 'selected');
            
            return values.map(value => 
                `<span class="attribute-value ${baseClass}">${value}</span>`
            ).join('');
        }

        function renderEditContainer(attr, index) {
            try {
                // Handle both comma and semicolon separated values
                let possibleValues = [];
                if (attr.possible_values) {
                    if (attr.possible_values.includes(';')) {
                        possibleValues = attr.possible_values.split(';').map(v => v.trim()).filter(v => v.length > 0);
                    } else {
                        possibleValues = attr.possible_values.split(',').map(v => v.trim()).filter(v => v.length > 0);
                    }
                }
                
                const currentValues = attr.current_selected_values || [];
                
                return `
                        <div class="edit-mode-selector" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #4b5563;">
                                <input type="radio" name="edit-mode-${index}" value="checkboxes" checked onchange="handleEditModeChange(${index}, 'checkboxes')">
                                Multiple Selection (Checkboxes)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem;">
                                <input type="radio" name="edit-mode-${index}" value="dropdown" onchange="handleEditModeChange(${index}, 'dropdown')">
                                Single Selection (Dropdown)
                            </label>
                        </div>
                        
                        <!-- Checkbox Mode -->
                        <div id="checkbox-mode-${index}" class="edit-mode-content">
                            <div class="possible-values-grid">
                                ${possibleValues.map(value => {
                                    const isSelected = currentValues.includes(value);
                                    const safeValue = value.replace(/'/g, "\\'").replace(/"/g, '\\"');
                                    return `
                                        <label class="value-button ${isSelected ? 'selected' : ''}" data-value="${safeValue}">
                                            <input type="checkbox" ${isSelected ? 'checked' : ''} data-attr-index="${index}" data-value="${safeValue}">
                                            <span>${value}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Dropdown Mode -->
                        <div id="dropdown-mode-${index}" class="edit-mode-content hidden">
                            <select class="value-dropdown" data-attr-index="${index}">
                                <option value="">Select a value...</option>
                                ${possibleValues.map(value => {
                                    const isSelected = currentValues.includes(value);
                                    const safeValue = value.replace(/'/g, "\\'").replace(/"/g, '\\"');
                                    return `<option value="${safeValue}" ${isSelected ? 'selected' : ''}>${value}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div class="custom-value-section">
                            <input type="text" class="custom-value-input" placeholder="Add custom value..." id="custom-input-${index}">
                            <div class="edit-actions">
                                <button class="btn btn-primary btn-small" onclick="safeAddCustomValue(${index})">
                                    <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add Custom
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="safeClearAllValues(${index})">
                                    <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Clear All
                                </button>
                            </div>
                        </div>
                `;
            } catch (error) {
                console.error('Error in renderEditContainer:', error);
                return '<div>Error rendering edit controls</div>';
            }
        }

        function setupEditListeners(attr, index) {
            // Add small delay to ensure DOM is rendered
            setTimeout(() => {
                try {
                    // Setup checkbox listeners
                    const checkboxes = document.querySelectorAll(`input[data-attr-index="${index}"][type="checkbox"]`);
                    checkboxes.forEach(checkbox => {
                        if (checkbox && !checkbox.hasAttribute('data-listener-added')) {
                            checkbox.setAttribute('data-listener-added', 'true');
                            checkbox.addEventListener('change', function() {
                                try {
                                    updateAttributeValues(index, this.dataset.value, this.checked);
                                } catch (error) {
                                    console.error('Error in checkbox change handler:', error);
                                }
                            });
                        }
                    });
                    
                    // Setup dropdown listener
                    const dropdown = document.querySelector(`select[data-attr-index="${index}"]`);
                    if (dropdown && !dropdown.hasAttribute('data-listener-added')) {
                        dropdown.setAttribute('data-listener-added', 'true');
                        dropdown.addEventListener('change', function() {
                            try {
                                handleDropdownChange(index, this.value);
                            } catch (error) {
                                console.error('Error in dropdown change handler:', error);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error in setupEditListeners:', error);
                }
            }, 100);
        }

        function toggleAttributeEditMode(attrIndex, mode) {
            try {
                const checkboxMode = document.getElementById(`checkbox-mode-${attrIndex}`);
                const dropdownMode = document.getElementById(`dropdown-mode-${attrIndex}`);
                
                if (!checkboxMode || !dropdownMode) {
                    console.warn(`Edit mode elements not found for attribute ${attrIndex}`);
                    return;
                }
                
                if (mode === 'checkboxes') {
                    checkboxMode.classList.remove('hidden');
                    dropdownMode.classList.add('hidden');
                } else {
                    checkboxMode.classList.add('hidden');
                    dropdownMode.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error in toggleAttributeEditMode:', error);
            }
        }

        function handleEditModeChange(attrIndex, mode) {
            toggleAttributeEditMode(attrIndex, mode);
        }

        function safeAddCustomValue(attrIndex) {
            try {
                addCustomValue(attrIndex);
            } catch (error) {
                console.error('Error in safeAddCustomValue:', error);
            }
        }

        function safeClearAllValues(attrIndex) {
            try {
                clearAllValues(attrIndex);
            } catch (error) {
                console.error('Error in safeClearAllValues:', error);
            }
        }

        function handleDropdownChange(attrIndex, selectedValue) {
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
            
            const attribute = currentProduct.attributes[attrIndex];
            
            // For dropdown, replace all values with the single selected value
            if (selectedValue) {
                attribute.current_selected_values = [selectedValue];
            } else {
                attribute.current_selected_values = [];
            }
            
            markProductAsChanged();
            
            // Update the values display
            const valuesContainer = document.getElementById(`values-container-${attrIndex}`);
            if (valuesContainer) {
                const hasChanges = hasAttributeChanges(attribute);
                valuesContainer.innerHTML = renderAttributeValues(attribute, attrIndex, hasChanges);
            }
            
            updateApproveButtonText();
        }

        function updateAttributeValues(attrIndex, value, isSelected) {
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
            
            const attribute = currentProduct.attributes[attrIndex];
            
            if (!attribute.current_selected_values) {
                attribute.current_selected_values = [];
            }
            
            if (isSelected && !attribute.current_selected_values.includes(value)) {
                attribute.current_selected_values.push(value);
            } else if (!isSelected) {
                attribute.current_selected_values = attribute.current_selected_values.filter(v => v !== value);
            }
            
            // Update checkbox styling
            const label = document.querySelector(`label[data-value="${value}"]`);
            if (label) {
                label.classList.toggle('selected', isSelected);
            }
            
            // Mark as changed
            markProductAsChanged();
            
            // Update the values display
            const valuesContainer = document.getElementById(`values-container-${attrIndex}`);
            if (valuesContainer) {
                const hasChanges = hasAttributeChanges(attribute);
                valuesContainer.innerHTML = renderAttributeValues(attribute, attrIndex, hasChanges);
            }
            
            updateApproveButtonText();
        }

        function addCustomValue(attrIndex) {
            const input = document.getElementById(`custom-input-${attrIndex}`);
            if (!input) return;
            
            const value = input.value.trim();
            
            if (value) {
                const currentProduct = groupedProducts[currentProductIndex];
                if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
                
                const attribute = currentProduct.attributes[attrIndex];
                
                if (!attribute.current_selected_values) {
                    attribute.current_selected_values = [];
                }
                
                if (!attribute.current_selected_values.includes(value)) {
                    attribute.current_selected_values.push(value);
                    markProductAsChanged();
                    
                    // Update the display
                    const valuesContainer = document.getElementById(`values-container-${attrIndex}`);
                    if (valuesContainer) {
                        const hasChanges = hasAttributeChanges(attribute);
                        valuesContainer.innerHTML = renderAttributeValues(attribute, attrIndex, hasChanges);
                    }
                    
                    updateApproveButtonText();
                }
                
                input.value = '';
            }
        }

        function clearAllValues(attrIndex) {
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !currentProduct.attributes[attrIndex]) return;
            
            const attribute = currentProduct.attributes[attrIndex];
            
            attribute.current_selected_values = [];
            markProductAsChanged();
            
            // Update checkboxes
            const checkboxes = document.querySelectorAll(`input[data-attr-index="${attrIndex}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const label = checkbox.closest('label');
                if (label) {
                    label.classList.remove('selected');
                }
            });
            
            // Update dropdown
            const dropdown = document.querySelector(`select[data-attr-index="${attrIndex}"]`);
            if (dropdown) {
                dropdown.value = '';
            }
            
            // Update the display
            const valuesContainer = document.getElementById(`values-container-${attrIndex}`);
            if (valuesContainer) {
                const hasChanges = hasAttributeChanges(attribute);
                valuesContainer.innerHTML = renderAttributeValues(attribute, attrIndex, hasChanges);
            }
            
            updateApproveButtonText();
        }

        function hasAttributeChanges(attribute) {
            if (!attribute) return false;
            
            const original = attribute.original_selected_value ? [attribute.original_selected_value] : [];
            const current = attribute.current_selected_values || [];
            
            // Custom metafields are always considered "changed" if they have values
            if (attribute.is_custom_metafield) {
                return current.length > 0;
            }
            
            if (original.length !== current.length) return true;
            
            return !original.every(val => current.includes(val)) || !current.every(val => original.includes(val));
        }

        function markProductAsChanged() {
            if (groupedProducts.length === 0 || currentProductIndex >= groupedProducts.length) return;
            
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct) return;
            
            productChanges[currentProduct.address] = true;
            updateCardStyling();
        }

        function updateDecisionButtons() {
            const currentProduct = groupedProducts[currentProductIndex];
            const currentDecision = decisions[currentProduct.address];
            
            const approveBtn = document.getElementById('approve-btn');
            const denyBtn = document.getElementById('deny-btn');
            const flagBtn = document.getElementById('flag-btn');
            
            approveBtn.classList.toggle('active', currentDecision === 'approve');
            denyBtn.classList.toggle('active', currentDecision === 'deny');
            flagBtn.classList.toggle('active', currentDecision === 'flag');
        }

        function updateCardStyling() {
            if (groupedProducts.length === 0 || currentProductIndex >= groupedProducts.length) return;
            
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct || !productCard) return;
            
            const currentDecision = decisions[currentProduct.address];
            const hasChanges = productChanges[currentProduct.address];
            
            productCard.classList.remove('approved', 'denied', 'flagged', 'modified');
            
            if (hasChanges) {
                productCard.classList.add('modified');
            } else if (currentDecision === 'approve') {
                productCard.classList.add('approved');
            } else if (currentDecision === 'deny') {
                productCard.classList.add('denied');
            } else if (currentDecision === 'flag') {
                productCard.classList.add('flagged');
            }
        }

        function updateApproveButtonText() {
            if (groupedProducts.length === 0 || currentProductIndex >= groupedProducts.length) return;
            
            const currentProduct = groupedProducts[currentProductIndex];
            if (!currentProduct) return;
            
            const hasChanges = productChanges[currentProduct.address];
            const approveText = document.getElementById('approve-text');
            
            if (approveText) {
                if (hasChanges) {
                    approveText.textContent = 'Save Changes and Approve';
                } else {
                    approveText.textContent = 'Approve Suggestions';
                }
            }
        }

        function updateProgress() {
            const reviewedCount = Object.keys(decisions).length;
            const totalCount = groupedProducts.length;
            const percentage = Math.round((reviewedCount / totalCount) * 100);
            
            document.getElementById('progress-count').textContent = `${reviewedCount} of ${totalCount} reviewed`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-percent').textContent = `${percentage}% complete`;
            
            if (reviewedCount > 0) {
                updateSummary();
                document.getElementById('summary-section').classList.remove('hidden');
            }
            
            if (reviewedCount > 0) {
                exportBtn.classList.remove('hidden');
                document.getElementById('export-count').textContent = reviewedCount;
            } else {
                exportBtn.classList.add('hidden');
            }
        }

        function updateSummary() {
            const approved = Object.values(decisions).filter(d => d === 'approve').length;
            const denied = Object.values(decisions).filter(d => d === 'deny').length;
            const flagged = Object.values(decisions).filter(d => d === 'flag').length;
            const pending = groupedProducts.length - Object.keys(decisions).length;
            
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('denied-count').textContent = denied;
            document.getElementById('flagged-count').textContent = flagged;
            document.getElementById('pending-count').textContent = pending;
        }

        function handleDecision(decision) {
            const currentProduct = groupedProducts[currentProductIndex];
            
            if (decision === 'flag') {
                // Prompt for enhancement notes
                const notes = prompt('Add notes for manual enhancement:\n\nWhat needs to be improved or corrected?');
                if (notes !== null) { // User didn't cancel
                    decisions[currentProduct.address] = decision;
                    enhancementNotes[currentProduct.address] = notes.trim();
                } else {
                    return; // User cancelled, don't set decision
                }
            } else {
                decisions[currentProduct.address] = decision;
                // Clear enhancement notes if not flagged
                delete enhancementNotes[currentProduct.address];
            }
            
            updateDisplay();
            
            if (currentProductIndex < groupedProducts.length - 1) {
                setTimeout(() => {
                    currentProductIndex++;
                    updateDisplay();
                }, 500);
            }
        }

        function prevProduct() {
            if (currentProductIndex > 0) {
                currentProductIndex--;
                updateDisplay();
            }
        }

        function nextProduct() {
            if (currentProductIndex < groupedProducts.length - 1) {
                currentProductIndex++;
                updateDisplay();
            }
        }

        function skipProduct() {
            if (currentProductIndex < groupedProducts.length - 1) {
                currentProductIndex++;
                updateDisplay();
            }
        }

        function exportDecisions() {
            // Get original headers and check if tracking columns already exist
            const originalHeaders = Object.keys(csvData[0]);
            const trackingColumns = ['decision', 'category_flagged', 'category_notes', 'enhancement_notes', 'changes_made', 'final_selected_value', 'custom_metafields', 'marked_not_applicable'];
            
            // Only add tracking columns if they don't already exist
            const newColumns = trackingColumns.filter(col => !originalHeaders.includes(col));
            const csvHeader = originalHeaders.concat(newColumns);
            
            const enhancedData = csvData.map(row => {
                const decision = decisions[row.address] || row.decision || '';
                const categoryFlagged = categoryFlags[row.address] ? 'true' : (row.category_flagged || 'false');
                const categoryNotesText = categoryNotes[row.address] || row.category_notes || '';
                const enhancementNotesText = enhancementNotes[row.address] || row.enhancement_notes || '';
                const changesMade = productChanges[row.address] ? 'true' : (row.changes_made || 'false');
                
                // Check if this specific attribute is marked as not applicable
                const attrKey = row.attribute_handle || row.attribute_name;
                const markedNotApplicable = (removedAttributes[row.address] && removedAttributes[row.address].includes(attrKey)) ? 'true' : (row.marked_not_applicable || 'false');
                
                // Find the final selected value for this specific attribute
                let finalSelectedValue = row.final_selected_value || '';
                const product = groupedProducts.find(p => p.address === row.address);
                if (product) {
                    const attr = product.attributes.find(a => 
                        a.attribute_name === row.attribute_name || 
                        a.attribute_handle === row.attribute_handle
                    );
                    if (attr && attr.current_selected_values && attr.current_selected_values.length > 0) {
                        finalSelectedValue = attr.current_selected_values.join(', ');
                    } else if (!finalSelectedValue && attr && attr.original_selected_value) {
                        finalSelectedValue = attr.original_selected_value;
                    }
                }
                
                // If marked as not applicable, override final value
                if (markedNotApplicable === 'true') {
                    finalSelectedValue = 'Not Applicable';
                }
                
                // Track custom metafields for this product
                let customMetafieldsInfo = row.custom_metafields || '';
                if (customMetafields[row.address] && customMetafields[row.address].length > 0) {
                    const customInfo = customMetafields[row.address].map(cf => 
                        `${cf.attribute_name}: ${cf.current_selected_values.join(', ')}`
                    ).join(' | ');
                    customMetafieldsInfo = customInfo;
                }
                
                // Create the row data starting with original values
                const rowData = [...Object.values(row)];
                
                // Update existing tracking columns or add new ones
                if (originalHeaders.includes('decision')) {
                    rowData[originalHeaders.indexOf('decision')] = decision;
                } else if (newColumns.includes('decision')) {
                    rowData.push(decision);
                }
                
                if (originalHeaders.includes('category_flagged')) {
                    rowData[originalHeaders.indexOf('category_flagged')] = categoryFlagged;
                } else if (newColumns.includes('category_flagged')) {
                    rowData.push(categoryFlagged);
                }
                
                if (originalHeaders.includes('category_notes')) {
                    rowData[originalHeaders.indexOf('category_notes')] = categoryNotesText;
                } else if (newColumns.includes('category_notes')) {
                    rowData.push(categoryNotesText);
                }
                
                if (originalHeaders.includes('enhancement_notes')) {
                    rowData[originalHeaders.indexOf('enhancement_notes')] = enhancementNotesText;
                } else if (newColumns.includes('enhancement_notes')) {
                    rowData.push(enhancementNotesText);
                }
                
                if (originalHeaders.includes('changes_made')) {
                    rowData[originalHeaders.indexOf('changes_made')] = changesMade;
                } else if (newColumns.includes('changes_made')) {
                    rowData.push(changesMade);
                }
                
                if (originalHeaders.includes('final_selected_value')) {
                    rowData[originalHeaders.indexOf('final_selected_value')] = finalSelectedValue;
                } else if (newColumns.includes('final_selected_value')) {
                    rowData.push(finalSelectedValue);
                }
                
                if (originalHeaders.includes('custom_metafields')) {
                    rowData[originalHeaders.indexOf('custom_metafields')] = customMetafieldsInfo;
                } else if (newColumns.includes('custom_metafields')) {
                    rowData.push(customMetafieldsInfo);
                }
                
                if (originalHeaders.includes('marked_not_applicable')) {
                    rowData[originalHeaders.indexOf('marked_not_applicable')] = markedNotApplicable;
                } else if (newColumns.includes('marked_not_applicable')) {
                    rowData.push(markedNotApplicable);
                }
                
                return rowData;
            });
            
            // Add rows for custom metafields that don't exist in original CSV
            Object.keys(customMetafields).forEach(productAddress => {
                const product = groupedProducts.find(p => p.address === productAddress);
                if (!product) return;
                
                customMetafields[productAddress].forEach(customAttr => {
                    // Check if this custom metafield already exists as a row in the original data
                    const existingRow = csvData.find(row => 
                        row.address === productAddress && 
                        (row.attribute_name === customAttr.attribute_name || 
                         row.attribute_handle === customAttr.attribute_handle)
                    );
                    
                    if (!existingRow) {
                        // Create a new row for this custom metafield
                        const newRow = new Array(csvHeader.length).fill('');
                        
                        // Fill in known values
                        const addressIndex = originalHeaders.indexOf('address');
                        const titleIndex = originalHeaders.indexOf('title');
                        const handleIndex = originalHeaders.indexOf('handle');
                        const categoryIndex = originalHeaders.indexOf('shopify_category');
                        const attrNameIndex = originalHeaders.indexOf('attribute_name');
                        const attrHandleIndex = originalHeaders.indexOf('attribute_handle');
                        const attrDescIndex = originalHeaders.indexOf('attribute_description');
                        const possibleValuesIndex = originalHeaders.indexOf('possible_values');
                        const selectedValueIndex = originalHeaders.indexOf('selected_value');
                        const aiProviderIndex = originalHeaders.indexOf('ai_provider');
                        const processingDateIndex = originalHeaders.indexOf('processing_date');
                        const metafieldTypeIndex = originalHeaders.indexOf('metafield_type');
                        
                        if (addressIndex !== -1) newRow[addressIndex] = productAddress;
                        if (titleIndex !== -1) newRow[titleIndex] = product.title;
                        if (handleIndex !== -1) newRow[handleIndex] = product.handle;
                        if (categoryIndex !== -1) newRow[categoryIndex] = product.shopify_category;
                        if (attrNameIndex !== -1) newRow[attrNameIndex] = customAttr.attribute_name;
                        if (attrHandleIndex !== -1) newRow[attrHandleIndex] = customAttr.attribute_handle;
                        if (attrDescIndex !== -1) newRow[attrDescIndex] = customAttr.attribute_description;
                        if (possibleValuesIndex !== -1) newRow[possibleValuesIndex] = customAttr.possible_values;
                        if (selectedValueIndex !== -1) newRow[selectedValueIndex] = customAttr.current_selected_values.join(', ');
                        if (aiProviderIndex !== -1) newRow[aiProviderIndex] = 'Custom Metafield';
                        if (processingDateIndex !== -1) newRow[processingDateIndex] = customAttr.processing_date;
                        if (metafieldTypeIndex !== -1) newRow[metafieldTypeIndex] = 'custom';
                        
                        // Add tracking columns
                        const decision = decisions[productAddress] || '';
                        const categoryFlagged = categoryFlags[productAddress] ? 'true' : 'false';
                        const changesMade = 'true'; // Custom metafields are always changes
                        const finalSelectedValue = customAttr.current_selected_values.join(', ');
                        const customMetafieldsInfo = `${customAttr.attribute_name}: ${customAttr.current_selected_values.join(', ')}`;
                        
                        if (originalHeaders.includes('decision')) {
                            newRow[originalHeaders.indexOf('decision')] = decision;
                        } else if (newColumns.includes('decision')) {
                            newRow[originalHeaders.length + newColumns.indexOf('decision')] = decision;
                        }
                        
                        if (originalHeaders.includes('category_flagged')) {
                            newRow[originalHeaders.indexOf('category_flagged')] = categoryFlagged;
                        } else if (newColumns.includes('category_flagged')) {
                            newRow[originalHeaders.length + newColumns.indexOf('category_flagged')] = categoryFlagged;
                        }
                        
                        if (originalHeaders.includes('changes_made')) {
                            newRow[originalHeaders.indexOf('changes_made')] = changesMade;
                        } else if (newColumns.includes('changes_made')) {
                            newRow[originalHeaders.length + newColumns.indexOf('changes_made')] = changesMade;
                        }
                        
                        if (originalHeaders.includes('final_selected_value')) {
                            newRow[originalHeaders.indexOf('final_selected_value')] = finalSelectedValue;
                        } else if (newColumns.includes('final_selected_value')) {
                            newRow[originalHeaders.length + newColumns.indexOf('final_selected_value')] = finalSelectedValue;
                        }
                        
                        if (originalHeaders.includes('custom_metafields')) {
                            newRow[originalHeaders.indexOf('custom_metafields')] = customMetafieldsInfo;
                        } else if (newColumns.includes('custom_metafields')) {
                            newRow[originalHeaders.length + newColumns.indexOf('custom_metafields')] = customMetafieldsInfo;
                        }
                        
                        enhancedData.push(newRow);
                    }
                });
            });
            
            // Escape CSV values properly
            const escapeValue = (value) => {
                if (value === null || value === undefined) return '';
                const str = String(value);
                if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };
            
            const csvContent = [
                csvHeader.map(escapeValue).join(','),
                ...enhancedData.map(row => row.map(escapeValue).join(','))
            ].join('\n');
            
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, 'enhanced_ai_suggestions_reviewed.csv');
                } else {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = 'enhanced_ai_suggestions_reviewed.csv';
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                
                const reviewedCount = Object.keys(decisions).length;
                const changesCount = Object.keys(productChanges).length;
                const flagsCount = Object.keys(categoryFlags).length;
                const customCount = Object.keys(customMetafields).reduce((total, key) => total + customMetafields[key].length, 0);
                const removedCount = Object.keys(removedAttributes).reduce((total, key) => total + removedAttributes[key].length, 0);
                const enhancementFlagsCount = Object.keys(enhancementNotes).length;
                
                console.log('Export successful:', {
                    reviewedCount,
                    changesCount,
                    flagsCount,
                    enhancementFlagsCount,
                    customMetafieldsCount: customCount,
                    removedAttributesCount: removedCount,
                    totalRows: enhancedData.length,
                    columnsAdded: newColumns
                });
                
                alert(`Export successful!\n\nRows exported: ${enhancedData.length}\nReviewed products: ${reviewedCount}\nProducts with changes: ${changesCount}\nCategory flags: ${flagsCount}\nEnhancement flags: ${enhancementFlagsCount}\nCustom metafields added: ${customCount}\nAttributes marked N/A: ${removedCount}`);
                
            } catch (error) {
                console.error('Export failed:', error);
                
                navigator.clipboard.writeText(csvContent).then(() => {
                    alert('Export failed, but CSV data has been copied to your clipboard!');
                }).catch(() => {
                    alert('Export failed. Please check browser console.');
                });
            }
        }

        // Global functions for onclick handlers
        window.addCustomValue = addCustomValue;
        window.clearAllValues = clearAllValues;
        window.toggleAttributeEditMode = toggleAttributeEditMode;
        window.handleEditModeChange = handleEditModeChange;
        window.safeAddCustomValue = safeAddCustomValue;
        window.safeClearAllValues = safeClearAllValues;
        window.openMetafieldModal = openMetafieldModal;
        window.closeMetafieldModal = closeMetafieldModal;
        window.handleMetafieldTypeChange = handleMetafieldTypeChange;
        window.addValueInput = addValueInput;
        window.addCustomMetafield = addCustomMetafield;
        window.removeAttribute = removeAttribute;
        window.restoreAttribute = restoreAttribute;
    </script>
</body>
</html>
