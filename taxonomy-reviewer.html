<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Product Taxonomy Reviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 2.25rem;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #64748b;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-area {
            background: white;
            border: 3px dashed #cbd5e1;
            border-radius: 1rem;
            padding: 4rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .upload-icon {
            width: 4rem;
            height: 4rem;
            color: #94a3b8;
            margin: 0 auto 1.5rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .card.high-priority {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #ffffff);
        }

        .card.medium-priority {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fefbf2, #ffffff);
        }

        .card.approved {
            background: linear-gradient(135deg, #f0fdf4, #ffffff);
            border-color: #22c55e;
        }

        .card.denied {
            background: linear-gradient(135deg, #fef2f2, #ffffff);
            border-color: #ef4444;
        }

        .card.changed {
            background: linear-gradient(135deg, #f0f9ff, #ffffff);
            border-color: #3b82f6;
        }

        .priority-indicator {
            position: absolute;
            top: -10px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .priority-high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }

        .priority-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .priority-low {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .product-grid {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .image-container {
            aspect-ratio: 1;
            border-radius: 1rem;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .image-icon {
            width: 5rem;
            height: 5rem;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .product-details h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #0f172a;
        }

        .product-details p {
            color: #475569;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .analysis-panel {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .analysis-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0f172a;
        }

        .quality-score {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .quality-indicators {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .indicator {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .indicator.high-quality {
            background: #dcfce7;
            color: #166534;
        }

        .indicator.models-agree {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .indicator.path-match {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .indicator.exact-match {
            background: #ecfdf5;
            color: #059669;
        }

        .indicator.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .indicator.error {
            background: #fecaca;
            color: #991b1b;
        }

        .path-comparison {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid #e2e8f0;
        }

        .path-comparison h4 {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1rem;
        }

        .path-item {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #e2e8f0;
        }

        .path-item.gpt1 {
            border-left-color: #3b82f6;
        }

        .path-item.gpt2 {
            border-left-color: #8b5cf6;
        }

        .path-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .path-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .shared-part {
            color: #6b7280;
            background: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }

        .unique-part {
            color: #0f172a;
            font-weight: 600;
            background: #fef3c7;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            margin-left: 0.25rem;
        }

        .categories-section {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .categories-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .category-count {
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            color: #475569;
        }

        .category-option {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .category-option:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .category-option.selected {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
            color: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }

        .category-option.current {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
            color: #92400e;
        }

        .category-text {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .category-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .confidence-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.375rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .confidence-badge.very-high {
            background: #dcfce7;
            color: #166534;
        }

        .confidence-badge.high {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .confidence-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-badge.low {
            background: #fecaca;
            color: #991b1b;
        }

        .source-badge {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            color: #7c3aed;
            padding: 0.375rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .decisions-section {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
        }

        .btn-approve {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border: 3px solid #22c55e;
            flex: 1;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            font-size: 1.125rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-approve:hover {
            background: linear-gradient(135deg, #bbf7d0, #86efac);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-approve.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(34, 197, 94, 0.4);
        }

        .btn-deny {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: #991b1b;
            border: 3px solid #ef4444;
            flex: 1;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            font-size: 1.125rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-deny:hover {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-deny.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.4);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .nav-counter {
            text-align: center;
        }

        .nav-counter .number {
            font-size: 2rem;
            font-weight: bold;
            color: #0f172a;
        }

        .nav-counter .total {
            font-size: 0.875rem;
            color: #64748b;
        }

        .progress-bar {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
            padding: 2rem;
            margin: 2rem 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }

        .progress-count {
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        .progress-track {
            width: 100%;
            background: #e2e8f0;
            border-radius: 2rem;
            height: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 2rem;
            transition: width 0.5s ease-out;
        }

        .progress-percent {
            text-align: right;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 600;
        }

        .summary {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
            padding: 2rem;
            margin: 2rem 0;
        }

        .summary h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0f172a;
            text-align: center;
            margin-bottom: 2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        .summary-item {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #e2e8f0;
        }

        .summary-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }

        .summary-number.approved { color: #22c55e; }
        .summary-number.denied { color: #ef4444; }
        .summary-number.pending { color: #64748b; }

        .summary-label {
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
        }

        .summary-bar {
            width: 3rem;
            height: 0.5rem;
            border-radius: 2rem;
            margin: 1rem auto 0;
        }

        .summary-bar.approved { background: #22c55e; }
        .summary-bar.denied { background: #ef4444; }
        .summary-bar.pending { background: #94a3b8; }

        .loading {
            text-align: center;
            padding: 4rem;
        }

        .spinner {
            width: 4rem;
            height: 4rem;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            margin: 0 auto 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .failure-notice {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            border: 2px solid #ef4444;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            color: #991b1b;
        }

        .failure-notice h4 {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1200px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .decisions-section {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1 class="title">Enhanced Taxonomy Reviewer</h1>
                <p class="subtitle" id="product-counter">Review and approve AI-generated product categories</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button id="export-btn" class="btn btn-primary hidden">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export (<span id="export-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- File Upload -->
        <div id="upload-section" class="upload-area">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h3 style="font-size: 1.25rem; font-weight: 600; color: #0f172a; margin-bottom: 0.75rem;">Upload Enhanced CSV File</h3>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Select your product taxonomy analysis CSV file to begin reviewing</p>
            <input type="file" accept=".csv" id="csv-upload" style="display: none;">
            <label for="csv-upload" class="btn btn-primary" style="cursor: pointer;">Choose File</label>
        </div>

        <!-- Loading -->
        <div id="loading-section" class="loading hidden">
            <div class="spinner"></div>
            <p style="color: #64748b; font-size: 1.125rem;">Processing enhanced taxonomy data...</p>
        </div>

        <!-- Product Review -->
        <div id="review-section" class="hidden">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-header">
                    <span class="progress-title">Review Progress</span>
                    <span class="progress-count" id="progress-count">0 of 0 reviewed</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-percent" id="progress-percent">0% complete</div>
            </div>

            <!-- Product Card -->
            <div id="product-card" class="card" style="position: relative;">
                <div id="priority-indicator" class="priority-indicator hidden"></div>
                
                <div class="product-grid">
                    <!-- Product Image -->
                    <div>
                        <div class="image-container">
                            <img id="product-image" class="product-image hidden" alt="Product Image">
                            <div id="image-placeholder" class="image-placeholder">
                                <div class="image-icon">
                                    <svg style="width: 2.5rem; height: 2.5rem; color: #3b82f6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <h3 id="image-status" style="font-weight: 600; color: #0f172a; margin-bottom: 0.5rem;">Loading Image...</h3>
                                <p id="image-description" style="font-size: 0.875rem; color: #64748b;">Please wait while we load the product image</p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="product-details">
                        <h1 id="product-title">Product Title</h1>
                        <p id="product-description">Product description...</p>
                    </div>

                    <!-- Analysis Panel -->
                    <div class="analysis-panel">
                        <div class="analysis-header">
                            <span class="analysis-title">AI Analysis</span>
                            <span class="quality-score" id="quality-score">Quality: 0%</span>
                        </div>
                        
                        <div class="quality-indicators" id="quality-indicators">
                            <!-- Quality indicators will be populated here -->
                        </div>

                        <div class="relationship-info" id="relationship-info">
                            <!-- Relationship analysis will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Failure Notice -->
                <div id="failure-notice" class="failure-notice hidden">
                    <h4>⚠️ Classification Issues Detected</h4>
                    <p id="failure-details">Details about classification failures...</p>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="categories-section">
                <div class="categories-header">
                    <h3 class="categories-title">Available Categories</h3>
                    <span class="category-count" id="category-count">0 options</span>
                </div>
                <div id="categories-container">
                    <!-- Category options will be populated here -->
                </div>
            </div>

            <!-- Decision Buttons -->
            <div class="decisions-section">
                <button id="approve-btn" class="btn-approve">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span id="approve-text">Approve Current Selection</span>
                </button>
                <button id="deny-btn" class="btn-deny">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Reject All Options
                </button>
            </div>

            <!-- Summary -->
            <div id="summary-section" class="summary hidden">
                <h3>Review Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-number approved" id="approved-count">0</div>
                        <div class="summary-label">Approved</div>
                        <div class="summary-bar approved"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number denied" id="denied-count">0</div>
                        <div class="summary-label">Rejected</div>
                        <div class="summary-bar denied"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number pending" id="pending-count">0</div>
                        <div class="summary-label">Pending</div>
                        <div class="summary-bar pending"></div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button id="prev-btn" class="btn btn-secondary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="nav-counter">
                    <div class="number" id="current-index">1</div>
                    <div class="total" id="total-count">of 0</div>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button id="skip-btn" class="btn btn-secondary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3-3 3m-4-6l3 3-3 3"></path>
                        </svg>
                        Skip
                    </button>
                    <button id="next-btn" class="btn btn-secondary">
                        Next
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let csvData = null;
        let products = [];
        let currentProductIndex = 0;
        let decisions = {};
        let selectedCategories = {};
        let imagePreloadCache = {};

        // DOM elements
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const reviewSection = document.getElementById('review-section');
        const csvUpload = document.getElementById('csv-upload');
        const exportBtn = document.getElementById('export-btn');
        const productCard = document.getElementById('product-card');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            csvUpload.addEventListener('change', handleFileUpload);
            exportBtn.addEventListener('click', exportDecisions);
            
            document.getElementById('prev-btn').addEventListener('click', prevProduct);
            document.getElementById('next-btn').addEventListener('click', nextProduct);
            document.getElementById('skip-btn').addEventListener('click', skipProduct);
            document.getElementById('approve-btn').addEventListener('click', () => handleDecision('approve'));
            document.getElementById('deny-btn').addEventListener('click', () => handleDecision('deny'));
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            
            try {
                const text = await file.text();
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    transformHeader: (header) => header.trim(),
                    transform: (value) => value ? value.toString().trim() : '',
                    complete: function(parsed) {
                        if (parsed.errors.length > 0) {
                            console.error('CSV parsing errors:', parsed.errors);
                        }
                        
                        processData(parsed.data);
                        hideLoading();
                        showReviewSection();
                    }
                });
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                alert('Error parsing CSV file. Please check the format.');
                hideLoading();
            }
        }

        function processData(data) {
            csvData = data;
            
            // Process each row as a product with enhanced taxonomy data
            products = data.map((row, index) => {
                const cleanCategory = (cat) => {
                    if (!cat) return '';
                    let cleaned = cat.replace(/^Category:\s*/i, '').trim();
                    if (cleaned.toLowerCase() === 'none of these') {
                        return 'None of these';
                    }
                    return cleaned;
                };

                return {
                    index: index,
                    handle: row['Product Handle'] || row.handle || '',
                    title: row['Title'] || row.title || '',
                    description: row['Desc'] || row.description || '',
                    imageUrl: row['ImageOG'] || row.image_url || '',
                    
                    // GPT categories
                    gpt1Category: cleanCategory(row['gpt1_category_desc'] || ''),
                    gpt2Category: cleanCategory(row['gpt2_category_desc'] || ''),
                    
                    // FAISS categories (up to 5)
                    faissCategory1: row['faiss_category_1'] || '',
                    faissConfidence1: parseFloat(row['faiss_confidence_1'] || '0'),
                    faissCategory2: row['faiss_category_2'] || '',
                    faissConfidence2: parseFloat(row['faiss_confidence_2'] || '0'),
                    faissCategory3: row['faiss_category_3'] || '',
                    faissConfidence3: parseFloat(row['faiss_confidence_3'] || '0'),
                    faissCategory4: row['faiss_category_4'] || '',
                    faissConfidence4: parseFloat(row['faiss_confidence_4'] || '0'),
                    faissCategory5: row['faiss_category_5'] || '',
                    faissConfidence5: parseFloat(row['faiss_confidence_5'] || '0'),
                    
                    // Agreement analysis
                    pathMatch: row['GPT1_vs_GPT2_path_match'] === true || row['GPT1_vs_GPT2_path_match'] === 'true',
                    exactMatch: row['GPT1_vs_GPT2_exact_match'] === true || row['GPT1_vs_GPT2_exact_match'] === 'true',
                    sharedDepth: parseInt(row['GPT1_vs_GPT2_shared_depth'] || '0'),
                    sharedPath: row['GPT1_vs_GPT2_shared_path'] || '',
                    matchType: row['GPT1_vs_GPT2_match_type'] || '',
                    relationship: row['GPT1_vs_GPT2_relationship'] || '',
                    agreementQuality: parseFloat(row['GPT1_vs_GPT2_agreement_quality'] || '0'),
                    
                    // Quality indicators
                    bothValid: row['GPT1_vs_GPT2_both_valid'] === true || row['GPT1_vs_GPT2_both_valid'] === 'true',
                    correctedModelsAgree: row['corrected_models_agree'] === true || row['corrected_models_agree'] === 'true',
                    highQualityAgreement: row['high_quality_agreement'] === true || row['high_quality_agreement'] === 'true',
                    
                    // Failure indicators
                    bothNoneOfThese: row['both_none_of_these'] === true || row['both_none_of_these'] === 'true',
                    eitherNoneOfThese: row['either_none_of_these'] === true || row['either_none_of_these'] === 'true',
                    faissFailed: row['faiss_failed'] === true || row['faiss_failed'] === 'true',
                    completeClassificationFailure: row['complete_classification_failure'] === true || row['complete_classification_failure'] === 'true',
                    
                    // Review metadata
                    needsManualReview: row['needs_manual_review'] === true || row['needs_manual_review'] === 'true',
                    reviewPriority: row['review_priority'] || 'low',
                    manualCategory: row['manual_category'] || '',
                    reviewNotes: row['review_notes'] || '',
                    reviewStatus: row['review_status'] || '',
                    
                    originalRow: row
                };
            });
            
            // Sort by priority (high -> medium -> low) and then by agreement quality
            products.sort((a, b) => {
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                const aPriority = priorityOrder[a.reviewPriority] || 1;
                const bPriority = priorityOrder[b.reviewPriority] || 1;
                
                if (aPriority !== bPriority) {
                    return bPriority - aPriority; // High priority first
                }
                
                // If same priority, sort by agreement quality (lower quality first for review)
                return a.agreementQuality - b.agreementQuality;
            });
            
            // Initialize tracking objects
            decisions = {};
            selectedCategories = {};
            
            console.log('Loaded', products.length, 'products with enhanced taxonomy data');
            
            currentProductIndex = 0;
            updateDisplay();
            preloadNextImages();
        }

        function showLoading() {
            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            reviewSection.classList.add('hidden');
        }

        function hideLoading() {
            loadingSection.classList.add('hidden');
        }

        function showReviewSection() {
            reviewSection.classList.remove('hidden');
        }

        function preloadNextImages() {
            for (let i = 1; i <= 3; i++) {
                const nextIndex = currentProductIndex + i;
                if (nextIndex < products.length) {
                    const nextProduct = products[nextIndex];
                    const imageUrl = nextProduct.imageUrl;
                    if (imageUrl && !imagePreloadCache[imageUrl]) {
                        const img = new Image();
                        img.onload = () => { imagePreloadCache[imageUrl] = true; };
                        img.src = imageUrl;
                    }
                }
            }
        }

        function loadProductImage(imageUrl) {
            const imageElement = document.getElementById('product-image');
            const placeholderElement = document.getElementById('image-placeholder');
            const statusElement = document.getElementById('image-status');
            const descriptionElement = document.getElementById('image-description');

            imageElement.classList.add('hidden');
            placeholderElement.classList.remove('hidden');

            if (!imageUrl) {
                statusElement.textContent = 'No Image Available';
                descriptionElement.textContent = 'This product does not have an associated image';
                return;
            }

            if (imagePreloadCache[imageUrl]) {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
                return;
            }

            statusElement.textContent = 'Loading Image...';
            descriptionElement.textContent = 'Please wait while we load the product image';

            const testImage = new Image();
            
            testImage.onload = function() {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
                imagePreloadCache[imageUrl] = true;
            };

            testImage.onerror = function() {
                statusElement.textContent = 'Image Load Failed';
                descriptionElement.textContent = 'Unable to load the product image';
            };

            testImage.src = imageUrl;
        }

        function updateDisplay() {
            if (products.length === 0) return;
            
            const currentProduct = products[currentProductIndex];
            
            document.getElementById('product-counter').textContent = 
                `Product ${currentProductIndex + 1} of ${products.length}`;
            
            document.getElementById('current-index').textContent = currentProductIndex + 1;
            document.getElementById('total-count').textContent = `of ${products.length}`;
            
            document.getElementById('prev-btn').disabled = currentProductIndex === 0;
            document.getElementById('next-btn').disabled = currentProductIndex === products.length - 1;
            document.getElementById('skip-btn').disabled = currentProductIndex === products.length - 1;
            
            document.getElementById('product-title').textContent = currentProduct.title;
            document.getElementById('product-description').textContent = currentProduct.description;
            
            loadProductImage(currentProduct.imageUrl);
            updateAnalysisPanel(currentProduct);
            updatePriorityIndicator(currentProduct);
            updateFailureNotice(currentProduct);
            updateCategoriesDisplay(currentProduct);
            updateDecisionButtons();
            updateProgress();
            updateCardStyling();
            
            preloadNextImages();
        }

        function updateAnalysisPanel(product) {
            // Update quality score
            const qualityPercent = Math.round(product.agreementQuality * 100);
            document.getElementById('quality-score').textContent = `Quality: ${qualityPercent}%`;
            
            // Update quality indicators
            const indicatorsContainer = document.getElementById('quality-indicators');
            indicatorsContainer.innerHTML = '';
            
            if (product.highQualityAgreement) {
                indicatorsContainer.innerHTML += '<span class="indicator high-quality">High Quality</span>';
            }
            
            if (product.correctedModelsAgree) {
                indicatorsContainer.innerHTML += '<span class="indicator models-agree">Models Agree</span>';
            }
            
            if (product.pathMatch) {
                indicatorsContainer.innerHTML += '<span class="indicator path-match">Path Match</span>';
            }
            
            if (product.exactMatch) {
                indicatorsContainer.innerHTML += '<span class="indicator exact-match">Exact Match</span>';
            }
            
            if (product.agreementQuality < 0.3) {
                indicatorsContainer.innerHTML += '<span class="indicator error">Low Agreement</span>';
            } else if (product.agreementQuality < 0.6) {
                indicatorsContainer.innerHTML += '<span class="indicator warning">Medium Agreement</span>';
            }
            
            // Update relationship info
            const relationshipContainer = document.getElementById('relationship-info');
            let relationshipText = '';
            
            if (product.relationship && product.sharedPath) {
                relationshipText = `<strong>Taxonomy Relationship:</strong> <span style="color: #3b82f6; font-weight: 600;">${product.relationship}</span> categories<br>`;
                relationshipText += `<strong>Shared Path:</strong> <span style="color: #6b7280;">${product.sharedPath}</span><br>`;
                relationshipText += `<strong>Shared Depth:</strong> ${product.sharedDepth} levels<br>`;
                
                if (product.matchType && product.matchType !== product.relationship) {
                    relationshipText += `<strong>Match Type:</strong> ${product.matchType}<br>`;
                }
                
                // Add explanation of the relationship
                let explanation = '';
                switch(product.relationship.toLowerCase()) {
                    case 'sibling':
                        explanation = 'Both categories share the same parent path but branch into different subcategories.';
                        break;
                    case 'parent':
                        explanation = 'One category is a parent of the other (more general → more specific).';
                        break;
                    case 'child':
                        explanation = 'One category is a child of the other (more specific → more general).';
                        break;
                    case 'ancestor':
                        explanation = 'One category is an ancestor of the other (general → specific, multiple levels).';
                        break;
                    case 'descendant':
                        explanation = 'One category is a descendant of the other (specific → general, multiple levels).';
                        break;
                    case 'cousin':
                        explanation = 'Categories share a common ancestor but are in different branches.';
                        break;
                    case 'exact':
                        explanation = 'Both models suggested exactly the same category path.';
                        break;
                }
                
                if (explanation) {
                    relationshipText += `<br><em style="color: #64748b; font-size: 0.9em;">${explanation}</em>`;
                }
            } else {
                relationshipText = 'No detailed relationship analysis available';
            }
            
            relationshipContainer.innerHTML = relationshipText;
        }

        function updatePriorityIndicator(product) {
            const indicator = document.getElementById('priority-indicator');
            
            if (product.needsManualReview && product.reviewPriority !== 'low') {
                indicator.classList.remove('hidden');
                indicator.className = `priority-indicator priority-${product.reviewPriority}`;
                indicator.textContent = `${product.reviewPriority.toUpperCase()} PRIORITY`;
            } else {
                indicator.classList.add('hidden');
            }
        }

        function updateFailureNotice(product) {
            const notice = document.getElementById('failure-notice');
            const details = document.getElementById('failure-details');
            
            const failures = [];
            
            if (product.completeClassificationFailure) {
                failures.push('Complete classification failure detected');
            }
            
            if (product.faissFailed) {
                failures.push('FAISS similarity search failed');
            }
            
            if (product.bothNoneOfThese) {
                failures.push('Both GPT models responded "None of these"');
            } else if (product.eitherNoneOfThese) {
                failures.push('One GPT model responded "None of these"');
            }
            
            if (failures.length > 0) {
                notice.classList.remove('hidden');
                details.textContent = failures.join('. ');
            } else {
                notice.classList.add('hidden');
            }
        }

        function updateCategoriesDisplay(product) {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            const categories = [];

            // Add GPT categories with relationship info
            if (product.gpt1Category && product.gpt1Category !== 'None of these') {
                categories.push({
                    text: product.gpt1Category,
                    source: 'GPT-1',
                    confidence: null,
                    isCurrent: true,
                    id: 'gpt1',
                    relationship: product.relationship,
                    sharedPath: product.sharedPath
                });
            }

            if (product.gpt2Category && 
                product.gpt2Category !== 'None of these' && 
                product.gpt2Category !== product.gpt1Category) {
                categories.push({
                    text: product.gpt2Category,
                    source: 'GPT-2',
                    confidence: null,
                    isCurrent: !product.gpt1Category,
                    id: 'gpt2',
                    relationship: product.relationship,
                    sharedPath: product.sharedPath
                });
            }

            // Add all 5 FAISS categories
            const faissCategories = [
                { cat: product.faissCategory1, conf: product.faissConfidence1, id: 'faiss1' },
                { cat: product.faissCategory2, conf: product.faissConfidence2, id: 'faiss2' },
                { cat: product.faissCategory3, conf: product.faissConfidence3, id: 'faiss3' },
                { cat: product.faissCategory4, conf: product.faissConfidence4, id: 'faiss4' },
                { cat: product.faissCategory5, conf: product.faissConfidence5, id: 'faiss5' }
            ];

            faissCategories.forEach(({ cat, conf, id }, index) => {
                if (cat && !categories.some(c => c.text === cat)) {
                    categories.push({
                        text: cat,
                        source: 'FAISS',
                        confidence: conf,
                        isCurrent: false,
                        id: id,
                        rank: index + 1
                    });
                }
            });

            // Show failure messages
            if (product.gpt1Category === 'None of these' || product.gpt2Category === 'None of these') {
                const noneDiv = document.createElement('div');
                noneDiv.className = 'category-option';
                noneDiv.style.background = 'linear-gradient(135deg, #fef2f2, #fecaca)';
                noneDiv.style.borderColor = '#ef4444';
                noneDiv.style.opacity = '0.8';
                noneDiv.innerHTML = `
                    <div class="category-text" style="font-style: italic; color: #991b1b;">
                        ${product.gpt1Category === 'None of these' ? 'GPT-1' : 'GPT-2'} responded: "None of these"
                    </div>
                    <div class="category-meta">
                        <span class="indicator error">No Suggestion</span>
                    </div>
                `;
                container.appendChild(noneDiv);
            }

            if (categories.length === 0) {
                const noOptionsDiv = document.createElement('div');
                noOptionsDiv.className = 'category-option';
                noOptionsDiv.style.background = '#f8fafc';
                noOptionsDiv.style.borderColor = '#cbd5e1';
                noOptionsDiv.style.opacity = '0.8';
                noOptionsDiv.innerHTML = `
                    <div class="category-text" style="font-style: italic; color: #64748b;">
                        No valid category suggestions available
                    </div>
                    <div class="category-meta">
                        <span class="source-badge" style="background: #f1f5f9; color: #64748b;">Manual Review Required</span>
                    </div>
                `;
                container.appendChild(noOptionsDiv);
                document.getElementById('category-count').textContent = '0 options';
                return;
            }

            document.getElementById('category-count').textContent = `${categories.length} options`;

            // Get current selection
            const currentSelection = selectedCategories[product.handle] || 
                                  (categories.find(c => c.isCurrent)?.id);

            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-option';
                div.dataset.categoryId = category.id;
                
                if (category.id === currentSelection) {
                    div.classList.add('selected');
                } else if (category.isCurrent && !selectedCategories[product.handle]) {
                    div.classList.add('current');
                }

                // Build enhanced meta info
                let metaInfo = `<span class="source-badge">${category.source}</span>`;
                
                if (category.confidence !== null) {
                    const confPct = (category.confidence * 100).toFixed(1);
                    let confClass = 'confidence-badge';
                    if (category.confidence >= 0.9) confClass += ' very-high';
                    else if (category.confidence >= 0.7) confClass += ' high';
                    else if (category.confidence >= 0.5) confClass += ' medium';
                    else confClass += ' low';
                    metaInfo += `<span class="${confClass}">${confPct}%</span>`;
                }
                
                if (category.rank) {
                    metaInfo += `<span class="source-badge" style="background: #e0e7ff; color: #3730a3;">#${category.rank}</span>`;
                }
                
                // Add relationship indicators for GPT models
                if (category.source.startsWith('GPT') && category.relationship) {
                    let relationshipBadge = '';
                    let relationshipColor = '';
                    
                    switch(category.relationship.toLowerCase()) {
                        case 'sibling':
                            relationshipBadge = 'Sibling Categories';
                            relationshipColor = 'background: #dbeafe; color: #1d4ed8;';
                            break;
                        case 'parent':
                            relationshipBadge = 'Parent → Child';
                            relationshipColor = 'background: #dcfce7; color: #166534;';
                            break;
                        case 'child':
                            relationshipBadge = 'Child → Parent';
                            relationshipColor = 'background: #f0fdf4; color: #15803d;';
                            break;
                        case 'ancestor':
                            relationshipBadge = 'Ancestor → Descendant';
                            relationshipColor = 'background: #f3e8ff; color: #7c3aed;';
                            break;
                        case 'descendant':
                            relationshipBadge = 'Descendant → Ancestor';
                            relationshipColor = 'background: #fdf4ff; color: #a855f7;';
                            break;
                        case 'cousin':
                            relationshipBadge = 'Cousin Categories';
                            relationshipColor = 'background: #fef3c7; color: #92400e;';
                            break;
                        default:
                            if (product.exactMatch) {
                                relationshipBadge = 'Exact Match';
                                relationshipColor = 'background: #ecfdf5; color: #059669;';
                            } else if (product.pathMatch) {
                                relationshipBadge = 'Path Match';
                                relationshipColor = 'background: #f0f9ff; color: #0284c7;';
                            }
                    }
                    
                    if (relationshipBadge) {
                        metaInfo += `<span class="indicator" style="${relationshipColor}">${relationshipBadge}</span>`;
                    }
                }

                // Create the main category display with path highlighting
                let categoryDisplay = category.text;
                
                // For GPT categories, highlight the shared vs different parts
                if (category.source.startsWith('GPT') && category.sharedPath && categories.length > 1) {
                    const sharedPath = category.sharedPath;
                    const fullPath = category.text;
                    
                    if (fullPath.startsWith(sharedPath)) {
                        const remainingPath = fullPath.slice(sharedPath.length);
                        categoryDisplay = `<span style="color: #6b7280; font-weight: 500;">${sharedPath}</span><span style="color: #0f172a; font-weight: 700;">${remainingPath}</span>`;
                    } else {
                        categoryDisplay = `<span style="color: #0f172a; font-weight: 700;">${fullPath}</span>`;
                    }
                }

                div.innerHTML = `
                    <div class="category-text" style="line-height: 1.5;">${categoryDisplay}</div>
                    <div class="category-meta">
                        ${metaInfo}
                    </div>
                `;

                div.addEventListener('click', () => selectCategory(product.handle, category.id, div));
                container.appendChild(div);
            });
        }

        function selectCategory(productHandle, categoryId, element) {
            // Remove selected class from all options
            document.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.remove('selected', 'current');
            });

            // Add selected class to clicked option
            element.classList.add('selected');

            // Store selection
            selectedCategories[productHandle] = categoryId;

            updateCardStyling();
            updateApproveButtonText();
        }

        function updateDecisionButtons() {
            const currentProduct = products[currentProductIndex];
            const currentDecision = decisions[currentProduct.handle];
            
            const approveBtn = document.getElementById('approve-btn');
            const denyBtn = document.getElementById('deny-btn');
            
            approveBtn.classList.toggle('active', currentDecision === 'approve');
            denyBtn.classList.toggle('active', currentDecision === 'deny');
        }

        function updateCardStyling() {
            if (products.length === 0 || currentProductIndex >= products.length) return;
            
            const currentProduct = products[currentProductIndex];
            if (!currentProduct || !productCard) return;
            
            const currentDecision = decisions[currentProduct.handle];
            const hasSelection = selectedCategories[currentProduct.handle];
            
            productCard.classList.remove('approved', 'denied', 'changed', 'high-priority', 'medium-priority');
            
            // Add priority styling
            if (currentProduct.reviewPriority === 'high') {
                productCard.classList.add('high-priority');
            } else if (currentProduct.reviewPriority === 'medium') {
                productCard.classList.add('medium-priority');
            }
            
            // Add decision styling
            if (hasSelection) {
                productCard.classList.add('changed');
            } else if (currentDecision === 'approve') {
                productCard.classList.add('approved');
            } else if (currentDecision === 'deny') {
                productCard.classList.add('denied');
            }
        }

        function updateApproveButtonText() {
            if (products.length === 0 || currentProductIndex >= products.length) return;
            
            const currentProduct = products[currentProductIndex];
            if (!currentProduct) return;
            
            const hasSelection = selectedCategories[currentProduct.handle];
            const approveText = document.getElementById('approve-text');
            
            if (approveText) {
                if (hasSelection) {
                    approveText.textContent = 'Approve Selected Category';
                } else {
                    approveText.textContent = 'Approve Current Category';
                }
            }
        }

        function updateProgress() {
            const reviewedCount = Object.keys(decisions).length;
            const totalCount = products.length;
            const percentage = Math.round((reviewedCount / totalCount) * 100);
            
            document.getElementById('progress-count').textContent = `${reviewedCount} of ${totalCount} reviewed`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-percent').textContent = `${percentage}% complete`;
            
            if (reviewedCount > 0) {
                updateSummary();
                document.getElementById('summary-section').classList.remove('hidden');
            }
            
            if (reviewedCount > 0) {
                exportBtn.classList.remove('hidden');
                document.getElementById('export-count').textContent = reviewedCount;
            } else {
                exportBtn.classList.add('hidden');
            }
        }

        function updateSummary() {
            const approved = Object.values(decisions).filter(d => d === 'approve').length;
            const denied = Object.values(decisions).filter(d => d === 'deny').length;
            const pending = products.length - Object.keys(decisions).length;
            
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('denied-count').textContent = denied;
            document.getElementById('pending-count').textContent = pending;
        }

        function handleDecision(decision) {
            const currentProduct = products[currentProductIndex];
            decisions[currentProduct.handle] = decision;
            
            updateDisplay();
            
            if (currentProductIndex < products.length - 1) {
                setTimeout(() => {
                    currentProductIndex++;
                    updateDisplay();
                }, 500);
            }
        }

        function prevProduct() {
            if (currentProductIndex > 0) {
                currentProductIndex--;
                updateDisplay();
            }
        }

        function nextProduct() {
            if (currentProductIndex < products.length - 1) {
                currentProductIndex++;
                updateDisplay();
            }
        }

        function skipProduct() {
            if (currentProductIndex < products.length - 1) {
                currentProductIndex++;
                updateDisplay();
            }
        }

        function getSelectedCategoryText(product, categoryId) {
            switch(categoryId) {
                case 'gpt1': return product.gpt1Category;
                case 'gpt2': return product.gpt2Category;
                case 'faiss1': return product.faissCategory1;
                case 'faiss2': return product.faissCategory2;
                case 'faiss3': return product.faissCategory3;
                case 'faiss4': return product.faissCategory4;
                case 'faiss5': return product.faissCategory5;
                default: return '';
            }
        }

        function exportDecisions() {
            // Get original headers and add enhanced tracking columns
            const originalHeaders = Object.keys(csvData[0]);
            const trackingColumns = [
                'decision', 
                'selected_category_source', 
                'final_category', 
                'category_changed', 
                'reviewer_notes',
                'agreement_quality_score',
                'priority_level'
            ];
            
            const newColumns = trackingColumns.filter(col => !originalHeaders.includes(col));
            const csvHeader = originalHeaders.concat(newColumns);
            
            const enhancedData = csvData.map((row, index) => {
                const product = products.find(p => p.index === index);
                if (!product) return Object.values(row);
                
                const decision = decisions[product.handle] || row.decision || '';
                const selectedCategoryId = selectedCategories[product.handle];
                
                let finalCategory = '';
                let categorySource = '';
                let categoryChanged = 'false';
                let reviewerNotes = '';
                
                if (selectedCategoryId) {
                    finalCategory = getSelectedCategoryText(product, selectedCategoryId);
                    categorySource = selectedCategoryId.startsWith('faiss') ? 'FAISS' : selectedCategoryId.toUpperCase();
                    categoryChanged = 'true';
                    reviewerNotes = `Selected ${categorySource} option: ${finalCategory}`;
                } else {
                    if (product.gpt1Category && product.gpt1Category !== 'None of these') {
                        finalCategory = product.gpt1Category;
                        categorySource = 'GPT1';
                    } else if (product.gpt2Category && product.gpt2Category !== 'None of these') {
                        finalCategory = product.gpt2Category;
                        categorySource = 'GPT2';
                    }
                    reviewerNotes = categorySource ? `Kept original ${categorySource} category` : 'No valid category available';
                }
                
                const rowData = [...Object.values(row)];
                
                // Update existing columns
                if (originalHeaders.includes('manual_category')) {
                    rowData[originalHeaders.indexOf('manual_category')] = selectedCategoryId ? finalCategory : row.manual_category;
                }
                
                if (originalHeaders.includes('review_notes')) {
                    const existingNotes = row.review_notes || '';
                    const newNotes = existingNotes ? `${existingNotes}; ${reviewerNotes}` : reviewerNotes;
                    rowData[originalHeaders.indexOf('review_notes')] = newNotes;
                }
                
                if (originalHeaders.includes('review_status')) {
                    rowData[originalHeaders.indexOf('review_status')] = decision === 'approve' ? 'approved' : 
                                                                       decision === 'deny' ? 'rejected' : 
                                                                       row.review_status || 'pending';
                }
                
                // Add new tracking columns
                newColumns.forEach(col => {
                    switch(col) {
                        case 'decision':
                            rowData.push(decision);
                            break;
                        case 'selected_category_source':
                            rowData.push(categorySource);
                            break;
                        case 'final_category':
                            rowData.push(finalCategory);
                            break;
                        case 'category_changed':
                            rowData.push(categoryChanged);
                            break;
                        case 'reviewer_notes':
                            rowData.push(reviewerNotes);
                            break;
                        case 'agreement_quality_score':
                            rowData.push(product.agreementQuality);
                            break;
                        case 'priority_level':
                            rowData.push(product.reviewPriority);
                            break;
                    }
                });
                
                return rowData;
            });
            
            const escapeValue = (value) => {
                if (value === null || value === undefined) return '';
                const str = String(value);
                if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };
            
            const csvContent = [
                csvHeader.map(escapeValue).join(','),
                ...enhancedData.map(row => row.map(escapeValue).join(','))
            ].join('\n');
            
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, 'enhanced_taxonomy_reviewed.csv');
                } else {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = 'enhanced_taxonomy_reviewed.csv';
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                
                const reviewedCount = Object.keys(decisions).length;
                const changedCount = Object.keys(selectedCategories).length;
                const highPriorityCount = products.filter(p => p.reviewPriority === 'high').length;
                
                alert(`Export successful!\n\nRows exported: ${enhancedData.length}\nReviewed products: ${reviewedCount}\nCategories changed: ${changedCount}\nHigh priority items: ${highPriorityCount}`);
                
            } catch (error) {
                console.error('Export failed:', error);
                
                navigator.clipboard.writeText(csvContent).then(() => {
                    alert('Export failed, but CSV data has been copied to your clipboard!');
                }).catch(() => {
                    alert('Export failed. Please check browser console.');
                });
            }
        }
    </script>
</body>
</html>
